

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geogenie.geogenie &mdash; GeoGenIE 1.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=292eb321"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GeoGenIE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">GeoGenIE Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../geogenie.html">geogenie package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GeoGenIE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">geogenie.geogenie</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geogenie.geogenie</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">optuna</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">spearmanr</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">root_mean_squared_error</span>

<span class="kn">from</span> <span class="nn">geogenie.models.models</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span> <span class="nn">geogenie.optimize.bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">geogenie.optimize.optuna_opt</span> <span class="kn">import</span> <span class="n">Optimize</span>
<span class="kn">from</span> <span class="nn">geogenie.plotting.plotting</span> <span class="kn">import</span> <span class="n">PlotGenIE</span>
<span class="kn">from</span> <span class="nn">geogenie.samplers.interpolate</span> <span class="kn">import</span> <span class="n">run_genotype_interpolator</span>
<span class="kn">from</span> <span class="nn">geogenie.samplers.samplers</span> <span class="kn">import</span> <span class="n">synthetic_resampling</span>
<span class="kn">from</span> <span class="nn">geogenie.utils.callbacks</span> <span class="kn">import</span> <span class="n">callback_init</span>
<span class="kn">from</span> <span class="nn">geogenie.utils.data</span> <span class="kn">import</span> <span class="n">CustomDataset</span>
<span class="kn">from</span> <span class="nn">geogenie.utils.data_structure</span> <span class="kn">import</span> <span class="n">DataStructure</span>
<span class="kn">from</span> <span class="nn">geogenie.utils.loss</span> <span class="kn">import</span> <span class="n">WeightedDRMSLoss</span><span class="p">,</span> <span class="n">WeightedHuberLoss</span><span class="p">,</span> <span class="n">weighted_rmse_loss</span>
<span class="kn">from</span> <span class="nn">geogenie.utils.scorers</span> <span class="kn">import</span> <span class="n">calculate_rmse</span><span class="p">,</span> <span class="n">kstest</span>
<span class="kn">from</span> <span class="nn">geogenie.utils.utils</span> <span class="kn">import</span> <span class="n">geo_coords_is_valid</span><span class="p">,</span> <span class="n">validate_is_numpy</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TQDM_DISABLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

<span class="n">execution_times</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="timer">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.timer">[docs]</a>
<span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that measures and stores the execution time of a function.</span>

<span class="sd">    Args:</span>
<span class="sd">        func (Callable): The function to be wrapped by the timer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: The wrapped function with timing functionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">execution_times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>



<div class="viewcode-block" id="save_execution_times">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.save_execution_times">[docs]</a>
<span class="k">def</span> <span class="nf">save_execution_times</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Appends the execution times to a CSV file. If the file doesn&#39;t exist, it creates one.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): The name of the file where data will be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># Check if the file is empty to decide whether to write headers</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Move to the end of the file</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check if file is empty</span>
            <span class="c1"># Write headers only if file is empty</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;Function Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Execution Time&quot;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">execution_times</span><span class="p">)</span></div>



<div class="viewcode-block" id="GeoGenIE">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE">[docs]</a>
<span class="k">class</span> <span class="nc">GeoGenIE</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class designed for predicting geographic localities from genomic SNP (Single Nucleotide Polymorphism) data using neural network and gradient boosting decision tree models.</span>

<span class="sd">    GeoGenIE facilitates the integration of genomic data analysis with geographic predictions, aiding in studies like population genetic and molecular ecology.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        args (argparse.Namespace): Command line arguments containing configurations for data processing, model training, and visualization.</span>
<span class="sd">        genotypes (np.ndarray): Genomic SNP data.</span>
<span class="sd">        samples (np.ndarray): Sample IDs.</span>
<span class="sd">        sample_data (dict): Dictionary containing sample data.</span>
<span class="sd">        locs (np.ndarray): Geographic coordinates of the samples.</span>
<span class="sd">        dtype (torch.dtype): Data type for PyTorch tensors.</span>
<span class="sd">        logger (logging.Logger): Logger object for logging messages.</span>
<span class="sd">        device (str): Device to run the computations on (CPU or GPU).</span>
<span class="sd">        plotting (PlotGenIE): PlotGenIE object for generating plots.</span>
<span class="sd">        boot (Bootstrap): Bootstrap object for bootstrapping predictions.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - This class is particularly useful in the fields of population genomics, evolutionary biology, and molecular ecology, where geographic predictions based on genomic data are crucial.</span>
<span class="sd">        - It requires genomic SNP data as input and utilizes neural network models for making geographic predictions.</span>
<span class="sd">        - The class supports data preprocessing, model training, and visualization of the results.</span>
<span class="sd">        - It also provides support for bootstrapping predictions and optimizing hyperparameters using Optuna.</span>
<span class="sd">        - The class is designed to handle large-scale genomic datasets and perform geographic predictions efficiently.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the GeoGenIE class with the provided command line arguments and sets up the necessary environment for geographic predictions from genomic data.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (argparse.Namespace): Command line arguments containing configurations for data processing, model training, and visualization.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The initialization process includes setting up the computational device (CPU or GPU), creating necessary directories for outputs, and initializing the plotting utility.</span>
<span class="sd">            - It prepares the class for handling genomic SNP data and associated geographic information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genotypes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float32&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>

        <span class="n">torch</span><span class="o">.</span><span class="n">set_default_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Construct output directory structure to store all output.</span>
        <span class="n">output_dir_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;plots&quot;</span><span class="p">,</span>
            <span class="s2">&quot;training&quot;</span><span class="p">,</span>
            <span class="s2">&quot;validation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">,</span>
            <span class="s2">&quot;logfiles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;predictions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bootstrap&quot;</span><span class="p">,</span>
            <span class="s2">&quot;models&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optimize&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plots/shapefile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;benchmarking&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bootstrap_predictions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bootstrap_metrics&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span>

        <span class="p">[</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">output_dir_list</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu_number</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span>
                <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span> <span class="o">=</span> <span class="n">PlotGenIE</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">basemap_fips</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">highlight_basemap_counties</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">shapefile</span><span class="p">,</span>
            <span class="n">show_plots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">show_plots</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">fontsize</span><span class="p">,</span>
            <span class="n">filetype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">filetype</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">plot_dpi</span><span class="p">,</span>
            <span class="n">remove_splines</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">remove_splines</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boot</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="GeoGenIE.total_execution_time_decorator">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.total_execution_time_decorator">[docs]</a>
    <span class="k">def</span> <span class="nf">total_execution_time_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to time the execution of a function and print the duration in Hours:Minutes:Seconds format. Logs the execution time using the class&#39;s logger.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (callable): The function to be timed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            callable: The wrapped function with execution time measurement.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">hours</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Execution time: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total execution time: </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="GeoGenIE.load_data">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.load_data">[docs]</a>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads genotypes from VCF file using pysam, then preprocesses the data by imputing, embedding, and transforming the input data.&quot;&quot;&quot;</span>
        <span class="n">vcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vcf</span>

        <span class="k">if</span> <span class="n">vcf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VCF file </span><span class="si">{</span><span class="n">vcf</span><span class="si">}</span><span class="s2"> cannot be NoneType.&quot;</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">DataStructure</span><span class="p">(</span><span class="n">vcf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">load_and_preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.save_model">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.save_model">[docs]</a>
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the trained model to a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The trained PyTorch model to save.</span>
<span class="sd">            filename (str): The path to the file where the model will be saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.train_rf">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.train_rf">[docs]</a>
    <span class="nd">@timer</span>
    <span class="k">def</span> <span class="nf">train_rf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clf_params</span><span class="p">,</span> <span class="n">objective_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trains an XGBRegressor model using the specified parameters and data loaders.</span>

<span class="sd">        The method supports data augmentation using SMOTE (Synthetic Minority Over-sampling Technique) and evaluates the model&#39;s performance using Root Mean Squared Error (RMSE).</span>

<span class="sd">        Args:</span>
<span class="sd">            clf_params (dict): Parameters for Random Forest or Gradient Boosting models.</span>
<span class="sd">            objective_mode (bool, optional): If True, the method is used for optimization objectives. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            RandomForestRegressor or XGBRegressor: The trained model.</span>
<span class="sd">            float: RMSE of the model on the validation set.</span>
<span class="sd">            (additional returns if not in objective_mode): Additional data related to model training and evaluation.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The function first checks if SMOTE is to be applied and performs data augmentation accordingly.</span>
<span class="sd">            - Depending on the configuration, either a Random Forest or a Gradient Boosting model is trained.</span>
<span class="sd">            - The performance of the trained model is evaluated using RMSE on the validation dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;X_train&quot;</span><span class="p">]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;y_train&quot;</span><span class="p">]</span>
        <span class="n">sample_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">samples_weight</span>

        <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">oversample_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">features</span><span class="p">,</span>
                <span class="n">labels</span><span class="p">,</span>
                <span class="n">sample_weights</span><span class="p">,</span>
                <span class="n">centroids</span><span class="p">,</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">bins</span><span class="p">,</span>
                <span class="n">centroids_orig</span><span class="p">,</span>
                <span class="n">bins_resampled</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">synthetic_resampling</span><span class="p">(</span>
                <span class="n">X_train</span><span class="p">,</span>
                <span class="n">y_train</span><span class="p">,</span>
                <span class="n">sample_weights</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_bins</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">oversample_method</span><span class="p">,</span>
                <span class="n">smote_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">oversample_neighbors</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Synthetic data augmentation failed during optimization. Pruning trial.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">objective_mode</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Synthetic data augmentation failed. Try adjusting the parameters supplied to SMOTE or SMOTER.&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">objective_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualize_oversampling</span><span class="p">(</span>
                    <span class="n">features</span><span class="p">,</span>
                    <span class="n">labels</span><span class="p">,</span>
                    <span class="n">sample_weights</span><span class="p">,</span>
                    <span class="n">df</span><span class="p">,</span>
                    <span class="n">bins_resampled</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_weights</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">sample_weights</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">sample_weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gradient_boosting</span><span class="p">:</span>
            <span class="n">X_train_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;X_train_val&quot;</span><span class="p">]</span>
            <span class="n">y_train_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;y_train_val&quot;</span><span class="p">]</span>
            <span class="n">X_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;X_val&quot;</span><span class="p">]</span>
            <span class="n">y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;y_val&quot;</span><span class="p">]</span>

        <span class="n">sample_weights_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

        <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">validate_is_numpy</span><span class="p">(</span>
            <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weights</span>
        <span class="p">)</span>
        <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">sample_weights_val</span> <span class="o">=</span> <span class="n">validate_is_numpy</span><span class="p">(</span>
            <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">sample_weights_val</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gradient_boosting</span><span class="p">:</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">clf_params</span><span class="p">[</span><span class="s2">&quot;use_lr_scheduler&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gb_use_lr_scheduler</span>
            <span class="k">if</span> <span class="n">clf_params</span><span class="p">[</span><span class="s2">&quot;use_lr_scheduler&quot;</span><span class="p">]:</span>
                <span class="n">learning_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">clf_params</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">],</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gb_n_estimators</span><span class="p">,</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">lrs</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">callback</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">learning_rates</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">lrs</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;n_estimators&quot;</span> <span class="ow">in</span> <span class="n">clf_params</span><span class="p">:</span>
            <span class="n">n_estimators</span> <span class="o">=</span> <span class="n">clf_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_estimators&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_estimators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gb_n_estimators</span>

        <span class="n">clf</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span>
            <span class="n">multi_strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gb_multi_strategy</span><span class="p">,</span>
            <span class="o">**</span><span class="n">clf_params</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gradient_boosting</span><span class="p">:</span>
            <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">features</span><span class="p">,</span>
                <span class="n">labels</span><span class="p">,</span>
                <span class="n">eval_metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gb_eval_metric</span><span class="p">,</span>
                <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_train_val</span><span class="p">,</span> <span class="n">y_train_val</span><span class="p">)],</span>
                <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">root_mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">objective_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_weights</span> <span class="o">=</span> <span class="n">sample_weights</span>

        <span class="k">if</span> <span class="n">objective_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">clf</span><span class="p">,</span> <span class="n">rmse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">clf</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">centroids</span></div>


<div class="viewcode-block" id="GeoGenIE.visualize_oversampling">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.visualize_oversampling">[docs]</a>
    <span class="k">def</span> <span class="nf">visualize_oversampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">bins_resampled</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualizes the effect of SMOTE (Synthetic Minority Over-sampling Technique) on the dataset.</span>

<span class="sd">        This method creates a visual comparison of the original and the oversampled datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (np.array or pandas.DataFrame): The feature set, either as a NumPy array or a DataFrame.</span>
<span class="sd">            labels (np.array or pandas.DataFrame): The label set, expected to contain &#39;x&#39; and &#39;y&#39; coordinates.</span>
<span class="sd">            sample_weights (np.array): Array of sample weights.</span>
<span class="sd">            df (pandas.DataFrame): Original DataFrame before applying SMOTE.</span>
<span class="sd">            bins_resampled (array-like): Array of bin labels for the data after applying SMOTE.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The method first validates and converts the features, labels, and sample weights to pandas DataFrames.</span>
<span class="sd">            - It then combines these into a single DataFrame and passes this to the `plot_smote_bins` method of the `PlotGenIE` class.</span>
<span class="sd">            - This visualization helps in understanding how SMOTE affects the distribution of samples across different geographical bins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">validate_is_numpy</span><span class="p">(</span>
            <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sample_weights</span>
        <span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="n">dfX</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">dfy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="n">dfX</span><span class="p">[</span><span class="s2">&quot;sample_weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_weights</span>
        <span class="n">df_smote</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dfX</span><span class="p">,</span> <span class="n">dfy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ytmp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">ytmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">ytmp</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ytmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ytmp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_smote_bins</span><span class="p">(</span><span class="n">df_smote</span><span class="p">,</span> <span class="n">bins_resampled</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_bins</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.train_model">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.train_model">[docs]</a>
    <span class="nd">@timer</span>
    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_loader</span><span class="p">,</span>
        <span class="n">val_loader</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">trial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">objective_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">do_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">early_stopping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lr_scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains a given model using specified parameters and data loaders.</span>

<span class="sd">        This method supports early stopping and learning rate scheduling, and evaluates the model&#39;s performance on the validation dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_loader (torch.utils.data.DataLoader): DataLoader for training data.</span>
<span class="sd">            val_loader (torch.utils.data.DataLoader): DataLoader for validation data.</span>
<span class="sd">            model (torch.nn.Module): The PyTorch model to train.</span>
<span class="sd">            optimizer (torch.optim.Optimizer): The optimizer for training the model.</span>
<span class="sd">            trial (optuna.trial.Trial, optional): Optuna trial object for hyperparameter optimization. Defaults to None.</span>
<span class="sd">            objective_mode (bool, optional): If True, the method is used for optimization objectives. Defaults to False.</span>
<span class="sd">            do_bootstrap (bool, optional): If True, performs bootstrap training. Defaults to False.</span>
<span class="sd">            early_stopping (EarlyStopping, optional): Early stopping callback. Defaults to None.</span>
<span class="sd">            lr_scheduler (torch.optim.lr_scheduler, optional): Learning rate scheduler. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple or None: Depending on the mode, returns trained model and additional training information or None if training failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">early_stopping</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">objective_mode</span> <span class="ow">or</span> <span class="n">do_bootstrap</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Must provide &#39;early_stopping&#39; argument if &#39;objective_mode is True&#39;, but got NoneType.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lr_scheduler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">objective_mode</span> <span class="ow">or</span> <span class="n">do_bootstrap</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Must provide &#39;lr_scheduler&#39; argument if &#39;objective_mode=True&#39;, but got NoneType.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">objective_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_bootstrap</span><span class="p">:</span>
            <span class="n">early_stopping</span><span class="p">,</span> <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">callback_init</span><span class="p">(</span>
                <span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">trial</span><span class="o">=</span><span class="n">trial</span>
            <span class="p">)</span>

        <span class="c1"># Calculate and log initial loss values</span>
        <span class="n">initial_train_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_step</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">initial_val_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_step</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">train_losses</span><span class="p">,</span> <span class="n">val_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_train_loss</span><span class="p">],</span> <span class="p">[</span><span class="n">initial_val_loss</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_loader_interp</span> <span class="o">=</span> <span class="n">train_loader</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">oversample_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_bootstrap</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">objective_mode</span>
        <span class="p">):</span>
            <span class="p">(</span>
                <span class="n">train_loader</span><span class="p">,</span>
                <span class="n">centroids</span><span class="p">,</span>
                <span class="n">features</span><span class="p">,</span>
                <span class="n">labels</span><span class="p">,</span>
                <span class="n">sample_weights</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">run_genotype_interpolator</span><span class="p">(</span>
                <span class="n">train_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">train_loader_interp</span> <span class="o">=</span> <span class="n">train_loader</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">):</span>
            <span class="c1"># Training</span>
            <span class="n">avg_train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>
                <span class="n">train_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">grad_clip</span><span class="p">,</span> <span class="n">objective_mode</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">avg_train_loss</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_train_loss</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model training failed at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">objective_mode</span> <span class="ow">and</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">optuna</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TrialPruned</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">do_bootstrap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">objective_mode</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Model training failed at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> during bootstrapping.&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_train_loss</span><span class="p">)</span>

            <span class="c1"># Validation</span>
            <span class="n">avg_val_loss</span><span class="p">,</span> <span class="n">sample_ids_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_step</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">val_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_val_loss</span><span class="p">)</span>

            <span class="c1"># Early Stopping and LR Scheduler</span>
            <span class="n">early_stopping</span><span class="p">(</span><span class="n">avg_val_loss</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">early_stopping</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Early stopping triggered at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">early_stopping</span><span class="o">.</span><span class="n">load_best_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">avg_val_loss</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">optuna</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TrialPruned</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">objective_mode</span> <span class="ow">or</span> <span class="n">do_bootstrap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">sample_ids_val</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">oversample_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sample_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sample_weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_weights</span> <span class="o">=</span> <span class="n">sample_weights</span>

        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_losses</span><span class="p">,</span> <span class="n">val_losses</span><span class="p">,</span> <span class="n">centroids</span></div>


<div class="viewcode-block" id="GeoGenIE.train_step">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.train_step">[docs]</a>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">grad_clip</span><span class="p">,</span> <span class="n">objective_mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a single training step.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_loader (torch.utils.data.DataLoader): DataLoader for training data.</span>
<span class="sd">            model (torch.nn.Module): The PyTorch model to train.</span>
<span class="sd">            optimizer (torch.optim.Optimizer): The optimizer for training the model.</span>
<span class="sd">            grad_clip (float): Value for gradient clipping.</span>
<span class="sd">            objective_mode (bool): If True, the method is used for optimization objectives.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or None: The average training loss or None if training failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_losses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_init</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">grad_clip</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">5.0</span><span class="p">)</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">objective_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optuna Trial failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">batch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_loss</span><span class="p">)</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">batch_loss</span>

        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avg_loss</span></div>


<div class="viewcode-block" id="GeoGenIE.test_step">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.test_step">[docs]</a>
    <span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a single validation step.</span>

<span class="sd">        Args:</span>
<span class="sd">            val_loader (torch.utils.data.DataLoader): DataLoader for validation data.</span>
<span class="sd">            model (torch.nn.Module): The PyTorch model to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The average validation loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">total_val_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_init</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
                <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">val_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">batch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_loss</span><span class="p">)</span>
                <span class="n">total_val_loss</span> <span class="o">+=</span> <span class="n">batch_loss</span>
                <span class="n">sample_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sids</span><span class="p">)</span>

        <span class="n">avg_val_loss</span> <span class="o">=</span> <span class="n">total_val_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avg_val_loss</span><span class="p">,</span> <span class="n">sample_ids</span></div>


<div class="viewcode-block" id="GeoGenIE._batch_init">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE._batch_init">[docs]</a>
    <span class="k">def</span> <span class="nf">_batch_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the batch for training or validation.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The PyTorch model to train or validate.</span>
<span class="sd">            batch (tuple): A tuple containing data, targets, and sample weights.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing data, targets, and sample weights as tensors moved to the appropriate device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">sample_ids</span> <span class="o">=</span> <span class="n">batch</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">sample_weight</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">sample_ids</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.compute_rolling_statistics">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.compute_rolling_statistics">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_rolling_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">window_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes rolling average and standard deviation over a specified window size.</span>

<span class="sd">        Args:</span>
<span class="sd">            times (list or array-like): A sequence of numerical values (e.g., times or scores).</span>
<span class="sd">            window_size (int): The number of elements to consider for each rolling window.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing two lists:</span>
<span class="sd">                - averages (list): The rolling averages.</span>
<span class="sd">                - std_devs (list): The rolling standard deviations.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - This method is useful for analyzing time series data where you need to smooth out short-term fluctuations and highlight longer-term trends or cycles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">averages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">std_devs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">averages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>
            <span class="n">std_devs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">averages</span><span class="p">,</span> <span class="n">std_devs</span></div>


<div class="viewcode-block" id="GeoGenIE.predict_locations">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.predict_locations">[docs]</a>
    <span class="k">def</span> <span class="nf">predict_locations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">data_loader</span><span class="p">,</span>
        <span class="n">outfile</span><span class="p">,</span>
        <span class="n">return_truths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">use_rf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">log_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict locations using the trained model and evaluate predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The trained model to use for predictions.</span>
<span class="sd">            data_loader (torch.utils.data.DataLoader): DataLoader for the prediction data.</span>
<span class="sd">            outfile (str): The path to the file where the predictions will be saved.</span>
<span class="sd">            return_truths (bool, optional): If True, return the ground truth values along with predictions. Defaults to False.</span>
<span class="sd">            use_rf (bool, optional): If True, use RandomForest model. Defaults to False.</span>
<span class="sd">            log_metrics (bool, optional): If True, log the prediction metrics. Defaults to True.</span>
<span class="sd">            bootstrap (bool, optional): If True, perform bootstrap predictions. Defaults to False.</span>
<span class="sd">            is_train (bool, optional): If True, indicates that the data is training data. Defaults to False.</span>
<span class="sd">            dataset (str, optional): The dataset being used. Defaults to None.</span>
<span class="sd">            is_val (bool, optional): If True, indicates that the data is validation data. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Predictions from the model.</span>
<span class="sd">            (optional) dict: Metrics related to the predictions if return_truths is True.</span>
<span class="sd">            (optional) numpy.ndarray: Ground truth values if return_truths is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_val</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sample_ids</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="n">ground_truth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">sample_ids</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rescale_predictions</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_val</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">rescale_predictions</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predictions</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Missing values found in predictions. It is likely that the predictions were not made correctly. Terminating execution.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Rescale predictions and ground truth to original scale</span>
            <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_prediction_metrics</span><span class="p">(</span>
                <span class="n">outfile</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">ground_truth</span><span class="p">,</span>
                <span class="n">log_metrics</span><span class="p">,</span>
                <span class="n">bootstrap</span><span class="p">,</span>
                <span class="n">is_train</span><span class="p">,</span>
                <span class="n">dataset</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Predictions for </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Dataset: </span><span class="si">{</span><span class="n">predictions</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">return_truths</span> <span class="ow">and</span> <span class="n">is_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">samples</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">return_truths</span> <span class="ow">and</span> <span class="n">is_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">samples</span></div>


<div class="viewcode-block" id="GeoGenIE.calculate_prediction_metrics">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.calculate_prediction_metrics">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_prediction_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outfile</span><span class="p">,</span>
        <span class="n">predictions</span><span class="p">,</span>
        <span class="n">ground_truth</span><span class="p">,</span>
        <span class="n">log_stats</span><span class="p">,</span>
        <span class="n">bootstrap</span><span class="p">,</span>
        <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate metrics for the predictions and ground truth.</span>

<span class="sd">        Args:</span>
<span class="sd">            outfile (str): The path to the file where the metrics will be saved.</span>
<span class="sd">            predictions (np.ndarray): Predictions from the model.</span>
<span class="sd">            ground_truth (np.ndarray): Ground truth values.</span>
<span class="sd">            log_stats (bool): If True, log the prediction metrics.</span>
<span class="sd">            bootstrap (bool): If True, perform bootstrap predictions.</span>
<span class="sd">            is_train (bool, optional): If True, indicates that the data is training data. Defaults to False.</span>
<span class="sd">            dataset (str, optional): The dataset being used. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the predictions, ground truth, and metrics dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">rescale_predictions</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">mad</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">coefficient_of_variation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">within_threshold</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>

        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">rescale_predictions</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span>
        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">rescale_predictions</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="c1"># Evaluate predictions</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_stats</span><span class="p">(</span>
            <span class="n">predictions</span><span class="p">,</span>
            <span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">mad</span><span class="p">,</span>
            <span class="n">coefficient_of_variation</span><span class="p">,</span>
            <span class="n">within_threshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">z_scores</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">haversine_errors</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># return the evaluation metrics along with the predictions</span>
        <span class="n">metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_metrics_dictionary</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_stats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bootstrap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_stats_to_logger</span><span class="p">(</span><span class="n">metrics_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bootstrap</span><span class="p">:</span>
            <span class="n">z_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">haversine_errors</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
                <span class="n">haversine_errors</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bootstrap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_train</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_error_distribution</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

            <span class="n">outfile2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">outfile2</span> <span class="o">=</span> <span class="n">outfile2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">outfile2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">):</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;validation&quot;</span>
                <span class="k">elif</span> <span class="n">part</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span>

            <span class="n">outfile_cumulative_dist</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_cumulative_error_distribution.png&quot;</span>
            <span class="p">)</span>

            <span class="n">outfile_zscores</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_zscores.png&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_cumulative_error_distribution</span><span class="p">(</span>
                <span class="n">haversine_errors</span><span class="p">,</span>
                <span class="n">outfile_cumulative_dist</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;percentile_25&quot;</span><span class="p">],</span>
                        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;percentile_50&quot;</span><span class="p">],</span>
                        <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;percentile_75&quot;</span><span class="p">],</span>
                    <span class="p">]</span>
                <span class="p">),</span>  <span class="c1"># percentiles np.ndarray</span>
                <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;median_dist&quot;</span><span class="p">],</span>
                <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;mean_dist&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_zscores</span><span class="p">(</span><span class="n">z_scores</span><span class="p">,</span> <span class="n">outfile_zscores</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">metrics_dict</span></div>


<div class="viewcode-block" id="GeoGenIE._create_metrics_dictionary">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE._create_metrics_dictionary">[docs]</a>
    <span class="k">def</span> <span class="nf">_create_metrics_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a dictionary for metrics from a list of values.</span>

<span class="sd">        Args:</span>
<span class="sd">            values (list): List of values in the specified order, with &#39;percentiles&#39; being a NumPy array at index 16.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># List of keys for the dictionary</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;root_mean_squared_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mean_dist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;median_dist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stdev_dist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kolmogorov_smirnov&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kolmogorov_smirnov_pval&quot;</span><span class="p">,</span>
            <span class="s2">&quot;skewness&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rho_p&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spearman_corr_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spearman_corr_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spearman_pvalue_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spearman_pvalue_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pearson_corr_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pearson_corr_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pearson_pvalue_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pearson_pvalue_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mad_haversine&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coefficient_of_variation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interquartile_range&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percentile_25&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percentile_50&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percentile_75&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percent_within_20km&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percent_within_50km&quot;</span><span class="p">,</span>
            <span class="s2">&quot;percent_within_75km&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mean_absolute_z_score&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Creating the dictionary</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">metrics</span></div>


<div class="viewcode-block" id="GeoGenIE.get_all_stats">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.get_all_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">coefficient_of_variation</span><span class="p">,</span> <span class="n">within_threshold</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes various statistics for predictions and ground truth.</span>

<span class="sd">        Args:</span>
<span class="sd">            predictions (np.ndarray): Predictions from the model.</span>
<span class="sd">            ground_truth (np.ndarray): Ground truth values.</span>
<span class="sd">            mad (callable): Function to compute median absolute deviation.</span>
<span class="sd">            coefficient_of_variation (callable): Function to compute coefficient of variation.</span>
<span class="sd">            within_threshold (callable): Function to compute percentage within a threshold.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing z-scores, a list of statistical values, and haversine errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">calculate_rmse</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span>
        <span class="n">haversine_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">haversine_distance</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="p">,</span> <span class="n">predictions</span>
        <span class="p">)</span>
        <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">)</span>
        <span class="n">median_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">)</span>
        <span class="n">std_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">)</span>

        <span class="p">(</span>
            <span class="n">spearman_corr_x</span><span class="p">,</span>
            <span class="n">spearman_corr_y</span><span class="p">,</span>
            <span class="n">spearman_p_value_x</span><span class="p">,</span>
            <span class="n">spearman_p_value_y</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_correlation_coef</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">spearmanr</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">pearson_corr_x</span><span class="p">,</span>
            <span class="n">pearson_corr_y</span><span class="p">,</span>
            <span class="n">pearson_p_value_x</span><span class="p">,</span>
            <span class="n">pearson_p_value_y</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_correlation_coef</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">pearsonr</span><span class="p">)</span>

        <span class="n">rho</span><span class="p">,</span> <span class="n">rho_p</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

        <span class="c1"># Calculate median absolute deviation for Haversine distances</span>
        <span class="n">haversine_mad</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">)</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">coefficient_of_variation</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">)</span>

        <span class="c1"># Inter-quartile range.</span>
        <span class="n">iqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

        <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>

        <span class="c1"># Percentage of predictions within &lt;N&gt; km error</span>
        <span class="n">percentage_within_20km</span> <span class="o">=</span> <span class="n">within_threshold</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">percentage_within_50km</span> <span class="o">=</span> <span class="n">within_threshold</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">percentage_within_75km</span> <span class="o">=</span> <span class="n">within_threshold</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">z_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">haversine_errors</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">haversine_errors</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
            <span class="n">haversine_errors</span>
        <span class="p">)</span>

        <span class="n">mean_absolute_z_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z_scores</span><span class="p">))</span>

        <span class="c1"># 0 is best, negative means overestimations, positive means</span>
        <span class="c1"># underestimations</span>
        <span class="n">ks</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">skew</span> <span class="o">=</span> <span class="n">kstest</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">z_scores</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">rmse</span><span class="p">,</span>
                <span class="n">mean_dist</span><span class="p">,</span>
                <span class="n">median_dist</span><span class="p">,</span>
                <span class="n">std_dist</span><span class="p">,</span>
                <span class="n">ks</span><span class="p">,</span>
                <span class="n">pval</span><span class="p">,</span>
                <span class="n">skew</span><span class="p">,</span>
                <span class="n">rho</span><span class="p">,</span>
                <span class="n">rho_p</span><span class="p">,</span>
                <span class="n">spearman_corr_x</span><span class="p">,</span>
                <span class="n">spearman_corr_y</span><span class="p">,</span>
                <span class="n">spearman_p_value_x</span><span class="p">,</span>
                <span class="n">spearman_p_value_y</span><span class="p">,</span>
                <span class="n">pearson_corr_x</span><span class="p">,</span>
                <span class="n">pearson_corr_y</span><span class="p">,</span>
                <span class="n">pearson_p_value_x</span><span class="p">,</span>
                <span class="n">pearson_p_value_y</span><span class="p">,</span>
                <span class="n">haversine_mad</span><span class="p">,</span>
                <span class="n">cv</span><span class="p">,</span>
                <span class="n">iqr</span><span class="p">,</span>
                <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">percentiles</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">percentage_within_20km</span><span class="p">,</span>
                <span class="n">percentage_within_50km</span><span class="p">,</span>
                <span class="n">percentage_within_75km</span><span class="p">,</span>
                <span class="n">mean_absolute_z_score</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">haversine_errors</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.print_stats_to_logger">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.print_stats_to_logger">[docs]</a>
    <span class="k">def</span> <span class="nf">print_stats_to_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs the computed metrics to the logger.</span>

<span class="sd">        Args:</span>
<span class="sd">            metrics (dict): Dictionary of metrics to log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation Haversine Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_dist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median Validation Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;median_dist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Standard deviation for Haversine Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stdev_dist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Root Mean Squared Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;root_mean_squared_error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Median Absolute Deviation of Prediction Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mad_haversine&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Coeffiecient of Variation for Prediction Error = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;coefficient_of_variation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Interquartile Range of Prediction Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;interquartile_range&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">perc</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">]:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;percentile_</span><span class="si">{</span><span class="n">perc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">perc</span><span class="si">}</span><span class="s2"> percentile of prediction error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">perc</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">]:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;percent_within_</span><span class="si">{</span><span class="n">perc</span><span class="si">}</span><span class="s2">km&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Percentage of samples with error within </span><span class="si">{</span><span class="n">perc</span><span class="si">}</span><span class="s2"> km = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mean Absolute Z-scores of Prediction Error (km) = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_absolute_z_score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Spearman&#39;s Correlation Coefficient for Longitude = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;spearman_corr_longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, P-value = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;spearman_pvalue_longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Spearman&#39;s Correlation Coefficient for Latitude = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;spearman_corr_latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, P-value = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;spearman_pvalue_latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Pearson&#39;s Correlation Coefficient for Longitude = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;pearson_corr_longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, P-value = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;pearson_pvalue_longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Pearson&#39;s Correlation Coefficient for Latitude = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;pearson_corr_latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, P-value = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;pearson_pvalue_latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># 0 is best, positive means more undeerestimations</span>
        <span class="c1"># negative means more overestimations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skewness = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;skewness&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Goodness of fit test.</span>
        <span class="c1"># Small P-value means poor fit.</span>
        <span class="c1"># I.e., significantly deviates from reference distribution.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Kolmogorov-Smirnov Test = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;kolmogorov_smirnov&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, P-value = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;kolmogorov_smirnov_pval&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.get_correlation_coef">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.get_correlation_coef">[docs]</a>
    <span class="k">def</span> <span class="nf">get_correlation_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">corr_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes correlation coefficients for predictions and ground truth.</span>

<span class="sd">        Args:</span>
<span class="sd">            predictions (np.ndarray): Predictions from the model.</span>
<span class="sd">            ground_truth (np.ndarray): Ground truth values.</span>
<span class="sd">            corr_func (callable): Function to compute correlation coefficients.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing correlation coefficients and p-values for both longitude and latitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corr_x</span><span class="p">,</span> <span class="n">p_value_x</span> <span class="o">=</span> <span class="n">corr_func</span><span class="p">(</span><span class="n">predictions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ground_truth</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">corr_y</span><span class="p">,</span> <span class="n">p_value_y</span> <span class="o">=</span> <span class="n">corr_func</span><span class="p">(</span><span class="n">predictions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ground_truth</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">corr_x</span><span class="p">,</span> <span class="n">corr_y</span><span class="p">,</span> <span class="n">p_value_x</span><span class="p">,</span> <span class="n">p_value_y</span></div>


<div class="viewcode-block" id="GeoGenIE.plot_bootstrap_aggregates">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.plot_bootstrap_aggregates">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_bootstrap_aggregates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">train_times</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots bootstrap aggregates and training times.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame containing bootstrap aggregates.</span>
<span class="sd">            train_times (list): List of training times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_bootstrap_aggregates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">avg_time</span><span class="p">,</span> <span class="n">stddev_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rolling_statistics</span><span class="p">(</span>
            <span class="n">train_times</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;plots&quot;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_avg_train_time.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">filetype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_times</span><span class="p">(</span><span class="n">avg_time</span><span class="p">,</span> <span class="n">stddev_time</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.perform_standard_training">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.perform_standard_training">[docs]</a>
    <span class="k">def</span> <span class="nf">perform_standard_training</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">best_params</span><span class="p">,</span> <span class="n">ModelClass</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform standard model training.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_loader (torch.utils.data.DataLoader): DataLoader for the training set.</span>
<span class="sd">            val_loader (torch.utils.data.DataLoader): DataLoader for the validation set.</span>
<span class="sd">            device (torch.device): Device for training (&#39;cpu&#39; or &#39;cuda&#39;).</span>
<span class="sd">            best_params (dict): Dictionary of parameters to use with model training.</span>
<span class="sd">            ModelClass (torch.nn.Module): Callable subclass for PyTorch model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the best model, training losses, validation losses, and centroids if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting standard model training.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ModelClass</span> <span class="o">!=</span> <span class="s2">&quot;GB&quot;</span><span class="p">:</span>
                <span class="c1"># Initialize the model</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ModelClass</span><span class="p">(</span>
                    <span class="n">input_size</span><span class="o">=</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_features</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span>
                    <span class="n">nlayers</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;nlayers&quot;</span><span class="p">],</span>
                    <span class="n">dropout_prop</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;dropout_prop&quot;</span><span class="p">],</span>
                    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">output_width</span><span class="o">=</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_labels</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

                <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_best_params</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                <span class="c1"># Train the model</span>
                <span class="p">(</span><span class="n">trained_model</span><span class="p">,</span> <span class="n">train_losses</span><span class="p">,</span> <span class="n">val_losses</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span>
                    <span class="n">train_loader</span><span class="p">,</span>
                    <span class="n">val_loader</span><span class="p">,</span>
                    <span class="n">model</span><span class="p">,</span>
                    <span class="n">optimizer</span><span class="p">,</span>
                    <span class="n">trial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">objective_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">do_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">trained_model</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">val_losses</span><span class="p">,</span>
                    <span class="n">__</span><span class="p">,</span>
                    <span class="n">___</span><span class="p">,</span>
                    <span class="n">____</span><span class="p">,</span>
                    <span class="n">centroids</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_rf</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="n">objective_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ModelClass</span> <span class="o">!=</span> <span class="s2">&quot;GB&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">trained_model</span><span class="p">,</span> <span class="n">train_losses</span><span class="p">,</span> <span class="n">val_losses</span><span class="p">,</span> <span class="n">centroids</span>
            <span class="k">return</span> <span class="n">trained_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">val_losses</span><span class="p">,</span> <span class="n">centroids</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error in perform_standard_training: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="GeoGenIE.extract_best_params">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.extract_best_params">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_best_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">best_params</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the best parameters for the optimizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            best_params (dict): Dictionary of best parameters.</span>
<span class="sd">            model (torch.nn.Module): The PyTorch model to train.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.optim.Optimizer: Optimizer for the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;lr&quot;</span> <span class="ow">in</span> <span class="n">best_params</span> <span class="k">else</span> <span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span>

        <span class="n">l2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;l2_weight&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;l2_weight&quot;</span> <span class="ow">in</span> <span class="n">best_params</span>
            <span class="k">else</span> <span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;l2_reg&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Define the criterion and optimizer</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span></div>


<div class="viewcode-block" id="GeoGenIE.write_pred_locations">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.write_pred_locations">[docs]</a>
    <span class="k">def</span> <span class="nf">write_pred_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_locations</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sample_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes predicted locations to a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            pred_locations (np.ndarray): Array of predicted locations. Expects shape (n_samples, 2).</span>
<span class="sd">            filename (str): The path to the file where predictions will be saved.</span>
<span class="sd">            sample_ids (np.ndarray): Array of sample IDs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame containing the predicted locations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing predicted coordinates to dataframe.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_locations</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Expected NumPy array or pandas.DataFrame for predicted locations, but got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pred_locations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pred_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Expected 2 or 3 columns for predicted locations, but got: </span><span class="si">{</span><span class="n">pred_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">pred_locations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred_locations</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="n">pred_locations_df</span><span class="p">[</span><span class="s2">&quot;sampleID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_ids</span>
            <span class="n">pred_locations_df</span> <span class="o">=</span> <span class="n">pred_locations_df</span><span class="p">[[</span><span class="s2">&quot;sampleID&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_locations_df</span> <span class="o">=</span> <span class="n">pred_locations</span>

        <span class="n">pred_locations_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_locations_df</span></div>


<div class="viewcode-block" id="GeoGenIE.load_best_params">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.load_best_params">[docs]</a>
    <span class="k">def</span> <span class="nf">load_best_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the best parameters from a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): The path to the file containing the best parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary of best parameters.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the file does not exist.</span>
<span class="sd">            TypeError: If the best parameters are not in the expected format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Could not find file storing best params: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid format detected for best parameters object. Expected dict, but got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">best_params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best Found Parameters: </span><span class="si">{</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_params</span></div>


<div class="viewcode-block" id="GeoGenIE.optimize_parameters">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.optimize_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ModelClass</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform parameter optimization using Optuna.</span>

<span class="sd">        Args:</span>
<span class="sd">            ModelClass (torch.nn.Module): The PyTorch model class for which the optimization is to be done.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Best parameters found by Optuna optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">do_gridsearch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Optuna parameter search is not enabled.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Optuna parameter search.&quot;</span><span class="p">)</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="n">Optimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">val_loader</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">test_loader</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">samples_weight</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span>
            <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">n_startup_trials</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">gb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gradient_boosting</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_rf</span> <span class="k">if</span> <span class="n">gb</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span>
        <span class="n">best_trial</span><span class="p">,</span> <span class="n">study</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">perform_optuna_optimization</span><span class="p">(</span><span class="n">ModelClass</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">process_optuna_results</span><span class="p">(</span><span class="n">study</span><span class="p">,</span> <span class="n">best_trial</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optuna optimization completed!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_trial</span><span class="o">.</span><span class="n">params</span></div>


<div class="viewcode-block" id="GeoGenIE.perform_bootstrap_training">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.perform_bootstrap_training">[docs]</a>
    <span class="k">def</span> <span class="nf">perform_bootstrap_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ModelClass</span><span class="p">,</span> <span class="n">best_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform bootstrap training using the provided parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            ModelClass (torch.nn.Module): The PyTorch model class to use.</span>
<span class="sd">            best_params (dict): Dictionary of best parameters found by Optuna or specified by the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">do_bootstrap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Bootstrap training is not enabled.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting bootstrap training.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boot</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">val_loader</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">test_loader</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s2">&quot;val_indices&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s2">&quot;test_indices&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="s2">&quot;pred_indices&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sample_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span>
            <span class="n">best_params</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boot</span><span class="o">.</span><span class="n">perform_bootstrap_training</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_locations</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_pred_locations</span><span class="p">,</span>
            <span class="n">ModelClass</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bootstrap training completed!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.evaluate_and_save_results">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.evaluate_and_save_results">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate_and_save_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">train_losses</span><span class="p">,</span>
        <span class="n">val_losses</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
        <span class="n">centroids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_rf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the model and save the results.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The trained model to evaluate.</span>
<span class="sd">            train_losses (list): List of training losses.</span>
<span class="sd">            val_losses (list): List of validation losses.</span>
<span class="sd">            dataset (str): The dataset to use for evaluation (&#39;val&#39; or &#39;test&#39;).</span>
<span class="sd">            centroids (np.ndarray, optional): Centroids if using synthetic resampling. Defaults to None.</span>
<span class="sd">            use_rf (bool, optional): If True, use RandomForest model. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating the model on the </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2"> set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Only &#39;val&#39; or &#39;test&#39; are supported for the &#39;dataset&#39; option.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Only &#39;val&#39; or &#39;test&#39; are supported for the &#39;dataset&#39; option.&quot;</span>
            <span class="p">)</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span>

        <span class="n">middir</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span>
            <span class="n">middir</span> <span class="o">=</span> <span class="s2">&quot;validation&quot;</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">val_loader</span>
        <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">test_loader</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid dataset provided. Expected &#39;val&#39; or &#39;test&#39;, but got: </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">y_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">centroids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_rf</span><span class="p">:</span>
            <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">y_train_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">middir</span><span class="si">}</span><span class="s2">_error_distributions.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">filetype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">val_errordist_outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="s2">&quot;plots&quot;</span> <span class="o">/</span> <span class="n">fn</span>

        <span class="n">val_preds</span><span class="p">,</span> <span class="n">val_metrics</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">val_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_locations</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">loader</span><span class="p">,</span>
            <span class="n">val_errordist_outfile</span><span class="p">,</span>
            <span class="n">return_truths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">use_rf</span><span class="o">=</span><span class="n">use_rf</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">train_preds</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">train_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_locations</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_loader_interp</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Don&#39;t make errordist plot for train data.</span>
            <span class="n">return_truths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">use_rf</span><span class="o">=</span><span class="n">use_rf</span><span class="p">,</span>
            <span class="n">log_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">val_preds</span><span class="p">)</span>
        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">train_preds</span><span class="p">)</span>
        <span class="n">geo_coords_is_valid</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Save validation results to file</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">middir</span><span class="si">}</span><span class="s2">_metrics.json&quot;</span>
        <span class="n">val_metric_outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="n">middir</span> <span class="o">/</span> <span class="n">fn</span>

        <span class="n">fn2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">middir</span><span class="si">}</span><span class="s2">_predictions.txt&quot;</span>
        <span class="n">val_preds_outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="n">middir</span> <span class="o">/</span> <span class="n">fn2</span>

        <span class="n">fn3</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_train_metrics.json&quot;</span>
        <span class="n">train_metric_outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="s2">&quot;training&quot;</span> <span class="o">/</span> <span class="n">fn3</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_pred_locations</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="n">val_preds_outfile</span><span class="p">,</span> <span class="n">val_samples</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">val_metric_outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">fout</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_metric_outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="n">fout</span><span class="p">,</span>
                <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validation metrics saved.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training metrics saved.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">):</span>
            <span class="c1"># Save training and validation losses to file</span>
            <span class="n">fn4</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_train_</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_results.json&quot;</span>
            <span class="n">train_outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="s2">&quot;training&quot;</span> <span class="o">/</span> <span class="n">fn4</span>
            <span class="n">training_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train_losses&quot;</span><span class="p">:</span> <span class="n">train_losses</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;val_losses&quot;</span><span class="p">:</span> <span class="n">val_losses</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn5</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_train_results.json&quot;</span>
            <span class="n">train_outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="s2">&quot;training&quot;</span> <span class="o">/</span> <span class="n">fn5</span>
            <span class="n">training_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train_losses&quot;</span><span class="p">:</span> <span class="n">train_losses</span><span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">training_results</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training and validation losses saved.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">val_preds</span> <span class="o">=</span> <span class="n">val_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># Plot training history</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_rf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_history</span><span class="p">(</span><span class="n">train_losses</span><span class="p">,</span> <span class="n">val_losses</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_geographic_error_distribution</span><span class="p">(</span>
            <span class="n">y_true</span><span class="p">,</span>
            <span class="n">val_preds</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">bbox_buffer</span><span class="p">,</span>
            <span class="n">marker_scale_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">sample_point_scale</span><span class="p">,</span>
            <span class="n">min_colorscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">min_colorscale</span><span class="p">,</span>
            <span class="n">max_colorscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">max_colorscale</span><span class="p">,</span>
            <span class="n">n_contour_levels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_contour_levels</span><span class="p">,</span>
            <span class="n">centroids</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">polynomial_regression_plot</span><span class="p">(</span>
            <span class="n">y_true</span><span class="p">,</span> <span class="n">val_preds</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">polynomial_regression_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_loader_interp</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">train_preds</span><span class="p">,</span>
            <span class="s2">&quot;train&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GeoGenIE.make_unseen_predictions">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.make_unseen_predictions">[docs]</a>
    <span class="k">def</span> <span class="nf">make_unseen_predictions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">use_rf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boot_rep</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes predictions on unseen data.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The trained model to use for predictions.</span>
<span class="sd">            device (torch.device): Device for training (&#39;cpu&#39; or &#39;cuda&#39;).</span>
<span class="sd">            use_rf (bool, optional): If True, use RandomForest model. Defaults to False.</span>
<span class="sd">            col_indices (list, optional): List of column indices to use for predictions. Defaults to None.</span>
<span class="sd">            boot_rep (int, optional): Bootstrap repetition index. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame containing the predicted locations if boot_rep is None.</span>
<span class="sd">            tuple: Tuple containing predicted locations and output file path if boot_rep is not None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">boot_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Making predictions on unseen data...&quot;</span><span class="p">)</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span>

        <span class="n">X_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;X_pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">col_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">boot_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;boot_rep&#39; must be provided if &#39;col_indices&#39; is defined.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">X_pred</span> <span class="o">=</span> <span class="n">X_pred</span><span class="p">[:,</span> <span class="n">col_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_rf</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

            <span class="c1"># Convert X_pred to a PyTorch tensor and move it to the correct</span>
            <span class="c1"># device (GPU or CPU)</span>
            <span class="n">pred_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_pred</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomDataset</span><span class="p">(</span>
                <span class="n">pred_tensor</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pred_samples&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="c1"># Ensures BatchNorm and Dropout layers behave correctly.</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

            <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">sids</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="n">sample_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sids</span><span class="p">)</span>

            <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sample_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pred_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_locations_scaled</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_pred</span><span class="p">)</span>
            <span class="n">pred_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_locations_scaled</span><span class="p">)</span>

        <span class="n">pth</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basedir</span> <span class="o">=</span> <span class="s2">&quot;predictions&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basedir</span> <span class="o">=</span> <span class="s2">&quot;bootstrap_predictions&quot;</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_bootrep</span><span class="si">{</span><span class="n">boot_rep</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">pth</span> <span class="o">=</span> <span class="n">pth</span> <span class="o">/</span> <span class="n">basedir</span> <span class="o">/</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="n">pth</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pred_outfile</span> <span class="o">=</span> <span class="n">pth</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_unknown_predictions.csv&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown Predictions: </span><span class="si">{</span><span class="n">pred_locations</span><span class="si">}</span><span class="s2">, Unknown Prediction Shape: </span><span class="si">{</span><span class="n">pred_locations</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">boot_rep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pred_locations</span><span class="p">,</span> <span class="n">pred_outfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_pred_locations</span><span class="p">(</span>
                <span class="n">pred_locations</span><span class="p">,</span> <span class="n">pred_outfile</span><span class="p">,</span> <span class="n">sample_ids</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">real_preds</span></div>


<div class="viewcode-block" id="GeoGenIE.train_test_predict">
<a class="viewcode-back" href="../../geogenie.html#geogenie.geogenie.GeoGenIE.train_test_predict">[docs]</a>
    <span class="k">def</span> <span class="nf">train_test_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the complete training, testing, and prediction pipeline.</span>

<span class="sd">        This method sets the seed, initializes the device, loads the data, performs parameter optimization, trains the model, evaluates and saves results, and makes predictions on unseen data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set seed and GPU</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu_number</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span>
                <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating output directory structure.&quot;</span><span class="p">)</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Creates DataStructure instance.</span>
            <span class="c1"># Loads and preprocesses data.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">define_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">params</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">criterion</span> <span class="o">==</span> <span class="s2">&quot;drms&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">WeightedDRMSLoss</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">criterion</span> <span class="o">==</span> <span class="s2">&quot;rmse&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">weighted_rmse_loss</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">criterion</span> <span class="o">==</span> <span class="s2">&quot;huber&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">WeightedHuberLoss</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">smoothing_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid &#39;--criterion&#39; argument provided. Expected one of &#39;drms&#39;, &#39;rmse&#39;, or &#39;huber&#39;, but got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">criterion</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">modelclass</span> <span class="o">=</span> <span class="s2">&quot;GB&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gradient_boosting</span> <span class="k">else</span> <span class="n">MLPRegressor</span>

            <span class="c1"># Parameter optimization with Optuna</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">do_gridsearch</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">load_best_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;--load_best_params was specified; skipping paramter optimization and loading best parameeters.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_parameters</span><span class="p">(</span><span class="n">ModelClass</span><span class="o">=</span><span class="n">modelclass</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">best_params</span>
                    <span class="c1"># Add only new keys from data_structure.params to</span>
                    <span class="c1"># best_params</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">best_params</span><span class="p">:</span>
                            <span class="n">best_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best found parameters: </span><span class="si">{</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">load_best_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_best_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">load_best_params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">best_params</span>

                <span class="c1"># Add only new keys from data_structure.params to best_params</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">best_params</span><span class="p">:</span>
                        <span class="n">best_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Best parameters loaded from parent directory </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">load_best_params</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Model Training</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">do_bootstrap</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">perform_bootstrap_training</span><span class="p">(</span><span class="n">modelclass</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>
            <span class="p">(</span>
                <span class="n">best_model</span><span class="p">,</span>
                <span class="n">train_losses</span><span class="p">,</span>
                <span class="n">val_losses</span><span class="p">,</span>
                <span class="n">centroids</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_standard_training</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">val_loader</span><span class="p">,</span>
                <span class="n">device</span><span class="p">,</span>
                <span class="n">best_params</span><span class="p">,</span>
                <span class="n">modelclass</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">use_rf</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">modelclass</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_and_save_results</span><span class="p">(</span>
                <span class="n">best_model</span><span class="p">,</span>
                <span class="n">train_losses</span><span class="p">,</span>
                <span class="n">val_losses</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
                <span class="n">centroids</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span>
                <span class="n">use_rf</span><span class="o">=</span><span class="n">use_rf</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_and_save_results</span><span class="p">(</span>
                <span class="n">best_model</span><span class="p">,</span>
                <span class="n">train_losses</span><span class="p">,</span>
                <span class="n">val_losses</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="n">centroids</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span>
                <span class="n">use_rf</span><span class="o">=</span><span class="n">use_rf</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">real_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_unseen_predictions</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">use_rf</span><span class="p">)</span>

            <span class="n">model_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;models&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_trained_model.pt&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process completed successfully!.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving model to: </span><span class="si">{</span><span class="n">model_out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_rf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">model_out</span><span class="p">)</span>

            <span class="n">exe_pth</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;benchmarking&quot;</span><span class="p">)</span>
            <span class="n">exe_pth</span> <span class="o">=</span> <span class="n">exe_pth</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_execution_times.csv&quot;</span>
            <span class="n">save_execution_times</span><span class="p">(</span><span class="n">exe_pth</span><span class="p">)</span>
            <span class="n">execution_times</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GeoGenIE execution succesfully completed!&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Bradley T. Martin and Tyler K. Chafin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>